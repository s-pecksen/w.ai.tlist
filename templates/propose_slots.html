{% extends "base.html" %}

{% block title %}Propose Slots for {{ patient.name }}{% endblock %}

{% block head %}
{{ super() }}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
<style>
    .patient-info-card {
        background-color: #e9ecef; /* Light grey background */
    }
    .slot-card {
        margin-bottom: 1rem;
    }
    .slot-details {
         font-size: 0.9rem;
         color: #6c757d;
    }
    .waitlist-availability { font-size: 0.85em; color: #6c757d; }
    /* Style for the email template textarea */
    #emailTemplate {
        min-height: 200px; /* Adjust as needed */
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <h1 class="mb-4">Propose Slots for {{ patient.name }}</h1>

    {# --- Patient Information Card --- #}
    <div class="card mb-4 patient-info-card">
        <div class="card-body">
            <h5 class="card-title">Patient Requirements</h5>
            <div class="row">
                <div class="col-md-6">
                    <p><strong>Name:</strong> {{ patient.name }}</p>
                    <p><strong>Phone:</strong> {{ patient.phone }}</p>
                    <p><strong>Email:</strong> {{ patient.email or 'N/A' }}</p>
                    <p><strong>Wait Time:</strong> {{ patient.wait_time }}</p>
                </div>
                <div class="col-md-6">
                    <p><strong>Appointment Type:</strong> {{ patient.appointment_type|replace('_', ' ')|title }}</p>
                    <p><strong>Duration:</strong> {{ patient.duration }} minutes</p>
                    <p><strong>Provider Preference:</strong> {{ patient.provider|title }}</p>
                    <p><strong>Availability:</strong>
                        {# --- Updated Availability Display --- #}
                        {% set availability = patient.get('availability', {}) %}
                        {% set mode = patient.get('availability_mode', 'available') %}
                        {% if not availability %}
                            <span class="text-muted">Any Day/Time</span>
                        {% else %}
                            <span class="waitlist-availability">
                            {% if mode == 'available' %}
                                <strong class="text-success">Available:</strong>
                            {% else %}
                                <strong class="text-danger">NOT Available:</strong>
                            {% endif %}
                            {% for day, periods in availability.items()|sort %}
                                {{ day[:3] }}({{ periods|join('/') }}){% if not loop.last %}; {% endif %}
                            {% endfor %}
                            </span>
                        {% endif %}
                        {# --- End Updated Availability Display --- #}
                    </p>
                </div>
            </div>
            {% if patient.reason %}
            <p><strong>Reason/Notes:</strong> {{ patient.reason }}</p>
            {% endif %}
        </div>
    </div>

    {# --- Matching Slots Section --- #}
    <h2 class="mb-3">Matching Available Slots</h2>

    {% if matching_slots %}
        <div class="row">
            {% for slot in matching_slots %}
            <div class="col-md-6 col-lg-4">
                <div class="card slot-card shadow-sm mb-4"> {# Added mb-4 for spacing #}
                    <div class="card-body d-flex flex-column"> {# Use flexbox for button alignment #}
                        <h5 class="card-title">{{ slot.provider }}</h5>
                        <div class="slot-details mb-3">
                            {% if slot.slot_date %}
                                <i class="bi bi-calendar-check"></i> {{ slot.slot_date.strftime('%A, %b %d, %Y') }}
                                {# --- Display Slot Period --- #}
                                {% if slot.slot_period %}
                                    ({{ slot.slot_period }})
                                {% endif %}
                                {# --- End Slot Period --- #}
                                <br>
                            {% else %}
                                <i class="bi bi-calendar-x"></i> Date Unknown<br>
                            {% endif %}
                            <i class="bi bi-clock"></i> Duration: {{ slot.duration }} minutes
                            {% if slot.notes %}
                                <br><i class="bi bi-journal-text"></i> Notes: {{ slot.notes }}
                            {% endif %}
                        </div>
                        {# Propose Slot Button - Triggers Modal #}
                        <button type="button" class="btn btn-primary w-100 mt-auto" data-bs-toggle="modal" data-bs-target="#proposeModal-{{ slot.id }}">
                            <i class="bi bi-send"></i> Propose Slot
                        </button>
                    </div>
                </div>
            </div>
            {# Modal definition moved outside this loop/row #}
            {% endfor %}
        </div> {# End .row #}

        {# --- Modal Definitions (Placed Outside the Row) --- #}
        {% for slot in matching_slots %}
            <div class="modal fade" id="proposeModal-{{ slot.id }}" tabindex="-1" aria-labelledby="proposeModalLabel-{{ slot.id }}" aria-hidden="true">
              <div class="modal-dialog modal-lg"> {# Larger modal #}
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title" id="proposeModalLabel-{{ slot.id }}">Propose Slot to {{ patient.name }}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                  </div>
                  {# Form to send email proposal #}
                  <form action="{{ url_for('send_proposal_email') }}" method="post"> {# TODO: Create this endpoint #}
                      <input type="hidden" name="patient_id" value="{{ patient.id }}">
                      <input type="hidden" name="slot_id" value="{{ slot.id }}">
                      <input type="hidden" name="patient_email" value="{{ patient.email }}">
                      <div class="modal-body">
                          <div class="mb-3">
                              <label for="emailSubject-{{ slot.id }}" class="form-label">Subject:</label>
                              <input type="text" class="form-control" id="emailSubject-{{ slot.id }}" name="email_subject" value="Appointment Slot Available for {{ patient.appointment_type|replace('_', ' ')|title }}">
                          </div>
                          <div class="mb-3">
                              <label for="emailTemplate-{{ slot.id }}" class="form-label">Email Body:</label>
                              <textarea class="form-control" id="emailTemplate-{{ slot.id }}" name="email_body" rows="10">
Dear {{ patient.name }},

Good news! We have an appointment slot available that might fit your needs.

Details:
Provider: {{ slot.provider }}
Date: {{ slot.slot_date.strftime('%A, %B %d, %Y') if slot.slot_date else 'Date TBD' }} {% if slot.slot_period %}({{ slot.slot_period }}){% endif %}
Duration: {{ slot.duration }} minutes
Appointment Type: {{ patient.appointment_type|replace('_', ' ')|title }}

{% if slot.notes %}Notes: {{ slot.notes }}{% endif %}

Please reply to this email or call us at [Your Phone Number] as soon as possible to confirm if you would like to book this slot. Slots are filled on a first-come, first-served basis.

If this time doesn't work, please let us know, and we'll keep you on the waitlist.

Sincerely,
[Your Clinic Name]
                              </textarea>
                          </div>
                          <p><small>Recipient: {{ patient.email or 'N/A (Cannot send email)' }}</small></p>
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        {# Disable button if no email #}
                        <button type="submit" class="btn btn-success" {% if not patient.email %}disabled title="Patient has no email address"{% endif %}>
                            <i class="bi bi-envelope-check-fill"></i> Send Proposal
                        </button>
                      </div>
                  </form>
                </div>
              </div>
            </div>
            {# --- End Modal --- #}
        {% endfor %}
        {# --- End Modal Definitions --- #}

    {% else %}
        <div class="alert alert-info" role="alert">
            <h4 class="alert-heading">No Matches Found</h4>
            <p>There are currently no available open slots that perfectly match this patient's requirements for provider preference, appointment duration, day, and time period availability.</p>
            <hr>
            <p class="mb-0">You can check the <a href="{{ url_for('list_cancelled_appointments') }}" class="alert-link">Open Slots page</a> to view all slots or add a new one.</p>
        </div>
    {% endif %}

    <div class="mt-4">
        <a href="{{ url_for('index') }}#waitlist-table" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> Back to Waitlist
        </a>
    </div>

</div>

{# Remove the old confirmation script if it's no longer needed, or adapt if necessary #}
{# <script> ... </script> #}

{% endblock %} 