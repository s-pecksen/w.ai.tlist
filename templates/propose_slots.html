{% extends "base.html" %}

{% block title %}Propose Slots for {{ patient.name }}{% endblock %}

{% block head %}
{{ super() }}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
<style>
    .patient-info-card {
        background-color: #e9ecef; /* Light grey background */
    }
    .slot-card {
        margin-bottom: 1rem;
    }
    .slot-details {
         font-size: 0.9rem;
         color: #6c757d;
    }
    .waitlist-availability { font-size: 0.85em; color: #6c757d; }
    /* Style for the email template textarea */
    #emailTemplate {
        min-height: 200px; /* Adjust as needed */
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <h1 class="mb-4">Propose Slots for {{ patient.name }}</h1>

    {# --- Patient Information Card --- #}
    <div class="card mb-4 patient-info-card">
        <div class="card-body">
            <h5 class="card-title">Patient Requirements</h5>
            <div class="row">
                <div class="col-md-6">
                    <p><strong>Name:</strong> {{ patient.name }}</p>
                    <p><strong>Phone:</strong> {{ patient.phone }}</p>
                    <p><strong>Email:</strong> {{ patient.email or 'N/A' }}</p>
                    <p><strong>Wait Time:</strong> {{ patient.wait_time }}</p>
                </div>
                <div class="col-md-6">
                    <p><strong>Appointment Type:</strong> {{ patient.appointment_type|replace('_', ' ')|title }}</p>
                    <p><strong>Duration:</strong> {{ patient.duration }} minutes</p>
                    <p><strong>Provider Preference:</strong> {{ patient.provider|title }}</p>
                    <p><strong>Availability:</strong>
                        {# --- Updated Availability Display --- #}
                        {% set availability = patient.get('availability', {}) %}
                        {% set mode = patient.get('availability_mode', 'available') %}
                        {% if not availability %}
                            <span class="text-muted">Any Day/Time</span>
                        {% else %}
                            <span class="waitlist-availability">
                            {% if mode == 'available' %}
                                <strong class="text-success">Available:</strong>
                            {% else %}
                                <strong class="text-danger">NOT Available:</strong>
                            {% endif %}
                            {% for day, periods in availability.items()|sort %}
                                {{ day[:3] }}({{ periods|join('/') }}){% if not loop.last %}; {% endif %}
                            {% endfor %}
                            </span>
                        {% endif %}
                        {# --- End Updated Availability Display --- #}
                    </p>
                </div>
            </div>
            {% if patient.reason %}
            <p><strong>Reason/Notes:</strong> {{ patient.reason }}</p>
            {% endif %}
        </div>
    </div>

    {# --- Matching Slots Section --- #}
    <h2 class="mb-3">Matching Available Slots</h2>

    {% if matching_slots %}
        <div class="row">
            {% for slot in matching_slots %}
            <div class="col-md-6 col-lg-4">
                <div class="card slot-card shadow-sm mb-4"> {# Added mb-4 for spacing #}
                    <div class="card-body d-flex flex-column"> {# Use flexbox for button alignment #}
                        <h5 class="card-title">{{ slot.provider }}</h5>
                        <div class="slot-details mb-3">
                            {% if slot.slot_date %}
                                <i class="bi bi-calendar-check"></i> {{ slot.slot_date.strftime('%A, %b %d, %Y') }}
                                {# --- Display Slot Period --- #}
                                {% if slot.slot_period %}
                                    ({{ slot.slot_period }})
                                {% endif %}
                                {# --- End Slot Period --- #}
                                <br>
                            {% else %}
                                <i class="bi bi-calendar-x"></i> Date Unknown<br>
                            {% endif %}
                             {# --- Display Specific Time --- #}
                            {% if slot.slot_time %}
                                <i class="bi bi-clock-fill"></i> Time: {{ slot.slot_time }}<br>
                            {% endif %}
                             {# --- End Specific Time --- #}
                            <i class="bi bi-clock"></i> Duration: {{ slot.duration }} minutes
                            {% if slot.notes %}
                                <br><i class="bi bi-journal-text"></i> Notes: {{ slot.notes }}
                            {% endif %}
                        </div>
                        {# Assign Slot Button - Direct POST to assign_appointment #}
                         <form action="{{ url_for('assign_appointment', patient_id=patient.id, appointment_id=slot.id) }}" method="post" class="mt-auto" onsubmit="return confirm('Assign {{ patient.name }} to this slot on {{ slot.slot_date.strftime('%a, %b %d') if slot.slot_date else 'Unknown Date' }}? This will remove them from the waitlist and remove the open slot.');">
                             <button type="submit" class="btn btn-success w-100">
                                 <i class="bi bi-check-circle-fill"></i> Assign & Confirm
                             </button>
                         </form>
                        {# --- REMOVED: Propose Slot Button and Modal Trigger --- #}
                        {# <button type="button" class="btn btn-primary w-100 mt-auto" data-bs-toggle="modal" data-bs-target="#proposeModal-{{ slot.id }}">
                            <i class="bi bi-send"></i> Propose Slot
                        </button> #}
                    </div>
                </div>
            </div>
            {# Modal definition moved outside this loop/row #}
            {% endfor %}
        </div> {# End .row #}

        {# --- REMOVED: Modal Definitions --- #}
        {# {% for slot in matching_slots %} ... modal code ... {% endfor %} #}

    {% else %}
        <div class="alert alert-info" role="alert">
            <h4 class="alert-heading">No Matches Found</h4>
            <p>There are currently no available open slots that perfectly match this patient's requirements for provider preference, appointment duration, and availability.</p> {# Simplified message #}
            <hr>
            {# --- UPDATED LINK --- #}
            <p class="mb-0">You can check the <a href="{{ url_for('index', _anchor='cancelled-slots-list') }}" class="alert-link">Open Slots list</a> on the main page or add a new one.</p>
        </div>
    {% endif %}

    <div class="mt-4">
        <a href="{{ url_for('index') }}#waitlist-table" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> Back to Waitlist
        </a>
    </div>

</div>

{# Remove the old confirmation script if it's no longer needed, or adapt if necessary #}
{# <script> ... </script> #}

<!-- Edit Patient Modal -->
<div class="modal fade" id="editPatientModal" tabindex="-1" aria-labelledby="editPatientModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editPatientModalLabel">Edit Patient Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="edit-patient-form-container">
          {% if not has_providers %}
            <div class="alert alert-warning" role="alert">
              <h4 class="alert-heading">No Providers Found</h4>
              <p>Cannot edit patient preference without available providers.</p>
              <hr>
              <p class="mb-0">Please visit the <a href="{{ url_for('list_providers') }}">Manage Providers</a> page to add providers first.</p>
            </div>
          {% else %}
            <form id="edit-patient-form" action="{{ url_for('update_patient', patient_id='PATIENT_ID_PLACEHOLDER') }}" method="post">
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="edit_name" class="form-label">Name*</label>
                  <input type="text" class="form-control" id="edit_name" name="name" required>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="edit_phone" class="form-label">Phone*</label>
                  <input type="tel" class="form-control" id="edit_phone" name="phone" required>
                </div>
              </div>
              <div class="mb-3">
                <label for="edit_email" class="form-label">Email (optional):</label>
                <input type="email" class="form-control" id="edit_email" name="email">
              </div>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="edit_appointment_type" class="form-label">Appointment Type*</label>
                  <select class="form-select" id="edit_appointment_type" name="appointment_type" required>
                    <option value="" disabled>Select Type</option>
                    <option value="hygiene">Hygiene</option>
                    <option value="recall">Recall</option>
                    <option value="resto">Resto</option>
                    <option value="x-ray">X-ray</option>
                    <option value="np_spec">NP Spec</option>
                    <option value="spec_exam">Spec Exam</option>
                    <option value="emergency_exam">Emergency Exam</option>
                    <option value="rct">RCT</option>
                    <option value="custom">Custom Appointment</option>
                  </select>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="edit_duration" class="form-label">Duration*</label>
                  <select class="form-select" id="edit_duration" name="duration" required>
                    <option value="" disabled>Select Duration</option>
                    <option value="30">30 minutes</option>
                    <option value="60">1 hour</option>
                    <option value="70">70 minutes</option>
                    <option value="90">1.5 hours</option>
                    <option value="120">2 hours</option>
                  </select>
                </div>
              </div>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="edit_provider" class="form-label">Provider Pref.*</label>
                  <select class="form-select" id="edit_provider" name="provider" required>
                    <option value="no preference">No Preference</option>
                    {% for provider_dict in providers %}
                      <option value="{{ provider_dict.name }}">{{ provider_dict.name }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="edit_urgency" class="form-label">Urgency*</label>
                  <select class="form-select" id="edit_urgency" name="urgency">
                    <option value="low">Low</option>
                    <option value="medium">Medium</option>
                    <option value="high">High</option>
                  </select>
                </div>
              </div>

              <!-- Availability Section with Mode Toggle -->
              <div class="mb-3 border p-3 rounded bg-light">
                <label class="form-label d-block mb-2">Patient Availability:</label>
                <div class="form-check form-check-inline">
                  <input class="form-check-input" type="radio" name="availability_mode" id="edit_mode_available" value="available">
                  <label class="form-check-label availability-label-available" for="edit_mode_available">
                    Specify AVAILABLE Times
                  </label>
                </div>
                <div class="form-check form-check-inline">
                  <input class="form-check-input" type="radio" name="availability_mode" id="edit_mode_unavailable" value="unavailable">
                  <label class="form-check-label availability-label-unavailable" for="edit_mode_unavailable">
                    Specify NOT Available Times
                  </label>
                </div>
                <small class="form-text text-muted d-block mt-1">
                  Select the days/times the patient IS available OR IS NOT available. Leave blank if fully flexible.
                </small>

                <div class="availability-grid mt-3">
                  {% set days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'] %}
                  {% for day in days %}
                  <div class="day-column">
                    <h6>{{ day }}</h6>
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" value="AM" id="edit_avail_{{ day|lower }}_am" name="avail_{{ day|lower }}_am">
                      <label class="form-check-label" for="edit_avail_{{ day|lower }}_am">AM</label>
                    </div>
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" value="PM" id="edit_avail_{{ day|lower }}_pm" name="avail_{{ day|lower }}_pm">
                      <label class="form-check-label" for="edit_avail_{{ day|lower }}_pm">PM</label>
                    </div>
                  </div>
                  {% endfor %}
                </div>
              </div>

              <div class="mb-3">
                <label for="edit_reason" class="form-label">Additional Notes:</label>
                <textarea class="form-control" id="edit_reason" name="reason" rows="2"></textarea>
              </div>
            </form>
          {% endif %}
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" form="edit-patient-form" class="btn btn-primary">Update Patient</button>
      </div>
    </div>
  </div>
</div>

<!-- Edit Slot Modal -->
<div class="modal fade" id="editSlotModal" tabindex="-1" aria-labelledby="editSlotModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editSlotModalLabel">Edit Open Slot</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="edit-slot-form" action="{{ url_for('update_cancelled_slot', appointment_id='SLOT_ID_PLACEHOLDER') }}" method="post">
          <div class="mb-3">
            <label for="edit_slot_provider" class="form-label">Provider</label>
            <select class="form-select" id="edit_slot_provider" name="provider" required>
              <option value="" disabled>Select Provider</option>
              {% for provider_dict in providers %}
                <option value="{{ provider_dict.name }}">{{ provider_dict.name }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="row">
            <div class="col-md-4 mb-3">
              <label for="edit_slot_date" class="form-label">Date</label>
              <input type="date" class="form-control" id="edit_slot_date" name="slot_date" required>
            </div>
            <div class="col-md-4 mb-3">
              <label for="edit_slot_time" class="form-label">Time*</label>
              <input type="time" class="form-control" id="edit_slot_time" name="slot_time" required>
            </div>
            <div class="col-md-4 mb-3">
              <label for="edit_slot_period" class="form-label">Period</label>
              <select class="form-select" id="edit_slot_period" name="slot_period" required>
                <option value="" disabled>Select AM/PM</option>
                <option value="AM">AM</option>
                <option value="PM">PM</option>
              </select>
            </div>
          </div>

          <div class="mb-3">
            <label for="edit_slot_duration" class="form-label">Duration</label>
            <select class="form-select" id="edit_slot_duration" name="duration" required>
              <option value="" disabled>Select Duration</option>
              <option value="30">30 minutes</option>
              <option value="60">1 hour</option>
              <option value="70">70 minutes</option>
              <option value="90">1.5 hours</option>
              <option value="120">2 hours</option>
            </select>
          </div>

          <div class="mb-3">
            <label for="edit_slot_notes" class="form-label">Notes (Optional)</label>
            <textarea class="form-control" id="edit_slot_notes" name="notes" rows="2"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" form="edit-slot-form" class="btn btn-primary">Save Changes</button>
      </div>
    </div>
  </div>
</div>

<!-- Propose Slot Modal -->
<div class="modal fade" id="proposeSlotModal" tabindex="-1" aria-labelledby="proposeSlotModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="proposeSlotModalLabel">Proposal Message</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label for="modalEmailBody" class="form-label">Message Template:</label>
          <textarea class="form-control" id="modalEmailBody" name="email_body" rows="10" readonly></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" id="copyTemplateButton">
          <i class="bi bi-clipboard"></i> Copy Message
        </button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Eligible Patients List Section (shown conditionally) -->
<div id="eligible-patients-section" class="row mb-4" style="display: {% if eligible_patients is not none and current_appointment %}block{% else %}none{% endif %};">
  <div class="col-md-12">
    <div class="card border-primary">
      <div class="card-header bg-primary text-white">
        <h5 class="mb-0">Eligible Patients Found for Slot</h5>
        <p class="mb-0" id="eligible-patients-slot-info">
          {% if current_appointment and current_appointment.slot_date %}
            {{ current_appointment.slot_date.strftime('%A, %B %d, %Y') }}
            {% if current_appointment.slot_period %}
              ({{ current_appointment.slot_period }})
            {% endif %}
            | Provider: {{ current_appointment.provider }} | Duration: {{ current_appointment.duration }} minutes
          {% else %}
            Slot Information
          {% endif %}
        </p>
      </div>
      <div class="card-body p-0">
        {% if eligible_patients is not none and eligible_patients|length > 0 %}
          <div class="table-responsive">
            <table class="table table-hover mb-0">
              <thead>
                <tr>
                  <th>Match</th>
                  <th>Patient</th>
                  <th>Contact</th>
                  <th>Availability</th>
                  <th>Wait Time</th>
                  <th>Appointment Details</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody>
                {% for patient in eligible_patients %}
                <tr class="eligibility-match">
                  <td>
                    <span class="patient-match-indicator"></span>
                    <span class="fw-bold">Perfect</span>
                  </td>
                  <td>{{ patient.name }}</td>
                  <td>
                    {{ patient.phone }}<br>
                    <small>{{ patient.email or "No email" }}</small>
                  </td>
                  <td>
                    {% set availability = patient.get('availability', {}) %}
                    {% set mode = patient.get('availability_mode', 'available') %}
                    {% if not availability %}
                      <span class="text-muted">Any Day/Time</span>
                    {% else %}
                      <span class="waitlist-availability">
                      {% if mode == 'available' %}
                        <strong class="text-success">Available:</strong>
                      {% else %}
                        <strong class="text-danger">NOT Available:</strong>
                      {% endif %}
                      {% for day, periods in availability.items()|sort %}
                        {{ day[:3] }}({{ periods|join('/') }}){% if not loop.last %}; {% endif %}
                      {% endfor %}
                      </span>
                    {% endif %}
                  </td>
                  <td>{{ patient.wait_time }}</td>
                  <td>
                    <div class="patient-details">
                      <div><strong>Type:</strong> {{ format_appointment_type(patient) }}</div>
                      <div><strong>Duration:</strong> {{ patient.duration }} min</div>
                      <div><strong>Provider Pref:</strong>
                        {% set patient_provider_lower = patient.provider|lower %}
                        {% set slot_provider_lower = current_appointment.provider|lower %}
                        {% if patient_provider_lower == slot_provider_lower %}
                          <span class="text-success">{{ patient.provider }}</span>
                        {% elif patient_provider_lower == 'no preference' or not patient.provider %}
                          <span class="text-muted">No Preference</span>
                        {% else %}
                          <span class="text-danger">{{ patient.provider }}</span>
                        {% endif %}
                      </div>
                      {% if patient.reason and patient.appointment_type.lower() != 'custom' %}
                        <div><strong>Notes:</strong> {{ patient.reason }}</div>
                      {% endif %}
                    </div>
                  </td>
                  <td>
                    {% if patient.id and current_appointment.id and current_appointment.slot_date and current_appointment.slot_time %}
                      <button type="button" class="btn btn-sm btn-info propose-slot-btn"
                              data-bs-toggle="modal" data-bs-target="#proposeSlotModal"
                              data-patient-id="{{ patient.id }}"
                              data-patient-name="{{ patient.name }}"
                              data-patient-first-name="{{ patient.name.split()[0] }}"
                              data-appointment-id="{{ current_appointment.id }}"
                              data-slot-weekday="{{ current_appointment.slot_date.strftime('%A') }}"
                              data-slot-date-str="{{ current_appointment.slot_date.strftime('%B %d, %Y') }}"
                              data-slot-time="{{ current_appointment.slot_time }}"
                              data-appointment-type="{{ format_appointment_type(patient)|replace(':', '')|trim }}"
                              data-provider-name="{{ current_appointment.provider }}"
                              data-patient-email="{{ patient.email or '' }}">
                        <i class="bi bi-send"></i> Propose Slot
                      </button>
                    {% else %}
                      <button class="btn btn-sm btn-secondary" disabled title="Missing patient/slot data">Error</button>
                    {% endif %}
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <div class="alert alert-info mb-0">
            No eligible patients found matching the provider, duration, and day of the week for this slot.
          </div>