{% extends "base.html" %}

{% block title %}Home - Waitlyst{% endblock %}

{% block head %}
{{ super() }}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
<style>
    /* Custom styles for availability grid */
    .availability-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 1rem;
        margin-bottom: 1rem;
    }
    .day-column {
        border: 1px solid #ddd;
        padding: 0.8rem;
        border-radius: 0.25rem;
        background-color: #f8f9fa;
    }
    .day-column h6 {
        margin-bottom: 0.5rem;
        text-align: center;
        font-weight: bold;
    }
    .urgency-high { background-color: #f8d7da; }
    .urgency-medium { background-color: #fff3cd; }
    .urgency-low { background-color: #cfe2ff; }
    .waitlist-availability { font-size: 0.85em; color: #6c757d; }
    .pending-details { font-size: 0.9em; font-style: italic; color: #6c757d;}
    .slot-details { font-size: 0.9rem; color: #6c757d; }
    .action-buttons form, .action-buttons button { display: inline-block; margin-right: 3px; margin-bottom: 5px; }
    .action-buttons .btn-group { width: 100%; }
</style>
{% endblock %}

{% block content %}
{% macro format_appointment_type(patient) %}
    {% set appt_type = patient.appointment_type.strip()|lower %}
    {% if appt_type == 'custom' %}
        Custom: {{ patient.reason|default('N/A', true) }}
    {% elif appt_type == 'rct' %}
        RCT
    {% elif appt_type == 'x-ray' or appt_type == 'xray' %}
        X-Ray
    {% elif appt_type == 'np_spec' or appt_type == 'np spec' %}
        NP Spec
    {% elif '_' in patient.appointment_type or ' ' in patient.appointment_type %}
        {{ patient.appointment_type.strip()|replace('_', ' ')|title }}
    {% else %}
        {{ patient.appointment_type.strip()|capitalize }}
    {% endif %}
{% endmacro %}

{# Removed logo to save space #}
<img src="{{ url_for('static', filename='waitlist-logo.png') }}" alt="Waitlyst Logo" class="header-logo">

<div class="container-fluid mt-3"> {# Use container-fluid for more width #}

    <div class="row">
        {# Restore Add Patient form column width #}
        <div class="col-lg-8 col-md-12 mx-auto">
            <div class="card mb-4">
                <div class="card-header">
                     <h5 class="mb-0">Add Patient</h5>
                 </div>
                <div class="card-body">
                    <div class="form-section" id="add-patient-form">
                        {% if not has_providers %}
                        <div class="alert alert-warning" role="alert">
                            <p class="mb-0">Please visit the <a href="{{ url_for('providers.list_providers') }}">Manage Providers</a> page to add providers before adding patients.</p>
                        </div>
                        {% else %}
                        <form action="{{ url_for('patients.add_patient') }}" method="post">
                            {# --- Add Patient Form Fields --- #}
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="name" class="form-label">Name*</label>
                                    <input type="text" class="form-control form-control-sm" id="name" name="name" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="phone" class="form-label">Phone*</label>
                                    <input type="tel" class="form-control form-control-sm" id="phone" name="phone" required>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="email" class="form-label">Email (optional):</label>
                                <input type="email" class="form-control form-control-sm" id="email" name="email">
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="appointment_type" class="form-label">Appointment Type*</label>
                                    <select class="form-select form-select-sm" id="appointment_type" name="appointment_type" required>
                                        <option value="" disabled selected>Select Type</option>
                                        {% if appointment_types_data %} {# Use data with durations #}
                                            {% for type_data in appointment_types_data %}
                                                <option value="{{ type_data.appointment_type|lower|replace(' ', '_') }}">{{ type_data.appointment_type }}</option>
                                            {% endfor %}
                                             <option value="custom">Custom...</option> {# Add custom option #}
                                        {% else %}
                                             <option value="hygiene">Hygiene</option> {# Fallback defaults #}
                                             <option value="recall">Recall</option>
                                             <option value="resto">Resto</option>
                                             <option value="custom">Custom...</option>
                                        {% endif %}
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="duration" class="form-label">Duration*</label>
                                    <select class="form-select form-select-sm" id="duration" name="duration" required>
                                        <option value="" disabled selected>Select Duration</option>
                                        {# Options populated by JS based on type_data #}
                                    </select>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="provider" class="form-label">Provider Pref.*</label>
                                    <select class="form-select form-select-sm" id="provider" name="provider" required>
                                        <option value="no preference">No Preference</option>
                                        {% for provider in providers %}
                                            <option value="{{ provider.id }}">
                                                {{ provider.first_name }}{% if provider.last_initial %} {{ provider.last_initial }}{% endif %}
                                            </option>
                                        {% endfor %}
                                    </select>
                                </div>
                                 <div class="col-md-6 mb-3">
                                    <label for="urgency" class="form-label">Urgency*</label>
                                    <select class="form-select form-select-sm" id="urgency" name="urgency">
                                        <option value="low">Low</option>
                                        <option value="medium" selected>Medium</option>
                                        <option value="high">High</option>
                                    </select>
                                </div>
                            </div>
                            <div class="mb-3 border p-3 rounded bg-light">
                                <label class="form-label d-block mb-2 fw-bold">Patient Availability:</label>
                                <small class="form-text text-muted d-block mb-3">Select days/times the patient is available for appointments. Leave blank if flexible.</small>
                                <div class="availability-grid">
                                    {% set days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'] %}
                                    {% for day in days %}
                                    <div class="day-column">
                                        <h6>{{ day[:3] }}</h6> {# Abbreviated day name #}
                                        <div class="form-check form-check-inline"> {# Inline AM/PM #}
                                            <input class="form-check-input" type="checkbox" value="AM" id="avail_{{ day|lower }}_am" name="avail_{{ day|lower }}_am">
                                            <label class="form-check-label" for="avail_{{ day|lower }}_am">AM</label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="checkbox" value="PM" id="avail_{{ day|lower }}_pm" name="avail_{{ day|lower }}_pm">
                                            <label class="form-check-label" for="avail_{{ day|lower }}_pm">PM</label>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="notes" class="form-label">Additional Notes:</label>
                                <textarea class="form-control form-control-sm" id="notes" name="notes" rows="2"></textarea>
                            </div>
                            <button type="submit" class="btn btn-primary w-100">Add to Waitlist</button>
                        </form>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div> <!-- End Add Patient Column -->
    </div> <!-- End Add Patient Row -->

    {# Place CSV Upload in its own row, below Add Patient #}
    {# REMOVED CSV Upload Card Block - Approximately lines 204 to 223 #}
        

    <div class="row">
        <div class="col-md-12">
            <h2 class="display-6">Current Patients</h2>
            {% if waitlist %}
                <div class="table-container">
                    <div class="table-responsive">
                    <table class="table table-sm table-striped table-hover align-middle" id="patients-table"> {# table-sm for denser table #}
                        <thead>
                            <tr>
                                <th style="width: 20%;">Patient</th>
                                <th style="width: 20%;">Details</th>
                                <th style="width: 20%;">Availability</th>
                                <th style="width: 15%;">Wait Time</th>
                                <th style="width: 25%;">Actions</th> {# Increased width for actions #}
                            </tr>
                        </thead>
                        <tbody>
                            {% for patient in waitlist %}
                                {% set row_class = '' %}
                                {# --- Urgency/Status Row Class Logic --- #}
                                {# Color row based on urgency ONLY if status is 'waiting' #}
                                {% if patient.status == 'waiting' %}
                                    {# High urgency or emergency gets red #}
                                    {% if patient.urgency == 'high' or patient.appointment_type.lower() == 'emergency_exam' %}
                                        {% set row_class = 'urgency-high' %}
                                    {% elif patient.urgency == 'medium' %}
                                        {% set row_class = 'urgency-medium' %}
                                    {% else %} {# low urgency #}
                                        {% set row_class = 'urgency-low' %}
                                    {% endif %}
                                {% endif %}
                                {# REMOVED: Status-based row classes for 'scheduled' and 'pending' #}
                                {# elif patient.status == 'scheduled' %}
                                {#    {% set row_class = 'table-secondary text-muted' %} #}
                                {# elif patient.status == 'pending' %}
                                {#    {% set row_class = 'patient-pending' %} #}

                                {# The emergency exam check below is removed as it's handled within the 'waiting' block now #}
                                {# elif patient.appointment_type.lower() == 'emergency_exam' %}
                                {#    {% set row_class = 'table-danger' %} #}

                                <tr class="{{ row_class }}" id="patient-{{ patient.id }}">
                                    <td>
                                        {{ patient.name }}<br>
                                        <small>{{ patient.phone }} <br> {{ patient.email or "No email" }}</small>
                                    </td>
                                    <td>
                                        {{ format_appointment_type(patient) }} ({{ patient.duration }} min)<br>
                                        <small>Pref: {{ patient.provider }}</small>
                                        {% if patient.status == 'pending' and patient.proposed_slot_details %}
                                          <div class="pending-details">
                                            <i class="bi bi-arrow-right-short"></i> Pending: {{ patient.proposed_slot_details }}
                                          </div>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% set availability = patient.get('availability', {}) %}
                                        {% if not availability %}
                                            <span class="text-muted">Any Day/Time</span>
                                        {% else %}
                                            <span class="patient-availability">
                                            <strong class="text-success">Available:</strong>
                                            {# Use capitalize for display consistency #}
                                            {% for day, periods in availability.items()|sort %}
                                                {{ day[:3].capitalize() }}({{ periods|join('/') }}){% if not loop.last %}; {% endif %}
                                            {% endfor %}
                                            </span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {{ patient.wait_time or "None" }}
                                    </td>
                                    <td class="action-buttons">
                                        {% if patient.status == 'waiting' or not patient.status %}
                                            {# Find Slots Button (triggers modal) #}
                                            <button type="button" class="btn btn-sm btn-primary find-slots-btn"
                                                    data-bs-toggle="modal"
                                                    data-bs-target="#findSlotsModal"
                                                    data-patient-id="{{ patient.id }}">
                                                <i class="bi bi-search"></i> Find Slots
                                            </button>
                                            {# Edit Button (goes to edit page) #}
                                            <a href="{{ url_for('patients.edit_patient', patient_id=patient.id) }}" class="btn btn-sm btn-secondary">
                                                <i class="bi bi-pencil"></i> Edit
                                            </a>
                                            {# Remove Button (form submitted via JS) #}
                                            <button type="button" class="btn btn-sm btn-danger remove-patient-btn"
                                                    data-patient-id="{{ patient.id }}"
                                                    data-patient-name="{{ patient.name }}">
                                                <i class="bi bi-trash"></i> Remove
                                            </button>
                                        {% elif patient.status == 'pending' and patient.proposed_slot_id %}
                                            <div class="btn-group" role="group">
                                                <form action="{{ url_for('slots.confirm_booking', slot_id=patient.proposed_slot_id, patient_id=patient.id) }}" method="post" class="d-inline">
                                                    <button type="submit" class="btn btn-sm btn-success" title="Confirm Booking"><i class="bi bi-check-circle"></i> Confirm</button>
                                                </form>
                                                <form action="{{ url_for('slots.cancel_proposal', slot_id=patient.proposed_slot_id, patient_id=patient.id) }}" method="post" class="d-inline">
                                                    <button type="submit" class="btn btn-sm btn-warning" title="Cancel Proposal"><i class="bi bi-x-circle"></i> Cancel</button>
                                                </form>
                                            </div>
                                        {% else %}
                                            <span class="badge bg-secondary">{{ patient.status | capitalize }}</span>
                                        {% endif %}
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    </div>
                </div>
            {% else %}
                <p>No patients on the list.</p>
            {% endif %}
        </div>
    </div>

</div>{# End container-fluid #}


<!-- Find Slots Modal (triggered from waitlist 'Find Slots' button) -->
<div class="modal fade" id="findSlotsModal" tabindex="-1" aria-labelledby="findSlotsModalLabel" aria-hidden="true">
   <div class="modal-dialog modal-xl"> {# Increased size to XL #}
     <div class="modal-content">
       <div class="modal-header">
         <h5 class="modal-title" id="findSlotsModalLabel">Find Matching Slot for Patient</h5>
         <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
       </div>
       <div class="modal-body">
         <p>Searching for available slots matching <strong id="find-slots-modal-patient-name">Patient</strong>'s requirements...</p>
         <div id="find-slots-modal-list">
           {# Slot cards will be loaded here by JS #}
           <div class="text-center">
             <div class="spinner-border text-primary" role="status">
               <span class="visually-hidden">Loading...</span>
             </div>
           </div>
         </div>
       </div>
       <div class="modal-footer">
         <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
       </div>
     </div>
   </div>
</div>


<!-- Propose Slot Modal (Triggered from button inside Find Slots Modal) -->
<div class="modal fade" id="proposeSlotModal" tabindex="-1" aria-labelledby="proposeSlotModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="proposeSlotModalLabel">Proposal Message</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p><strong>To:</strong> <span id="propose-modal-patient-name"></span><br>
           <strong>Slot:</strong> <span id="propose-modal-slot-details"></span></p>
        <hr>
        <div class="mb-3">
          <label for="modalEmailBody" class="form-label">Message Template:</label>
          {# Store user/clinic name info from backend in data attributes for JS - REMOVED |tojson #}
          <textarea class="form-control" id="modalEmailBody" name="email_body" rows="10" readonly
                    data-user-name="{{ current_user_name }}"
                    data-clinic-name="{{ current_clinic_name }}"></textarea>
        </div>
        {# Hidden form for the "Mark Proposed" action #}
        <form id="markProposedForm" action="" method="post" class="d-none">
             {# Action URL will be set by JS #}
        </form>
      </div>
      <div class="modal-footer justify-content-between">
        {# Left side: Mark Proposed button #}
        <button type="submit" form="markProposedForm" class="btn btn-warning" id="markProposedButton" title="Mark slot and patient as pending without copying message">
            <i class="bi bi-bookmark-check"></i> Mark Proposed
        </button>
        {# Right side: Copy and Close buttons #}
        <div>
            <button type="button" class="btn btn-primary" id="copyTemplateButton">
              <i class="bi bi-clipboard"></i> Copy Message
            </button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>
</div>


{# REMOVED Edit Patient Modal Definition (using separate page now) #}

{% endblock %} {# End of content block #}

{% block scripts %}
{{ super() }}
<script>
    // Shared helper function (can be moved to static/app.js later)
    function escapeHTML(str) {
        if (!str) return '';
        return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
    }

    // Function to format date string (YYYY-MM-DD) nicely
    function formatDisplayDate(dateStr) {
        if (!dateStr) return 'Unknown Date';
        try {
            // Use T00:00:00Z for UTC date parsing, then display in local
            const dateObj = new Date(dateStr + 'T00:00:00Z');
            const options = { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric', timeZone: 'UTC' }; // Use UTC for date part
            return dateObj.toLocaleDateString(undefined, options); // Display local date
        } catch (e) {
            console.error("Error formatting date:", dateStr, e);
            return dateStr; // Return original string on error
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        // --- Add Patient Form Logic (Dynamic Duration/Reason) ---
        const addAppointmentTypeSelect = document.getElementById('appointment_type');
        const addDurationSelect = document.getElementById('duration');
        const addReasonLabel = document.querySelector('label[for="notes"]');
        const addReasonField = document.getElementById('notes');
        const appointmentTypesData = JSON.parse('{{ appointment_types_data|tojson|safe }}'); // Load data passed from Flask

        function updateAddDurationOptions() {
             if (!addAppointmentTypeSelect || !addDurationSelect) return;
             const selectedTypeValue = addAppointmentTypeSelect.value;

             // Clear existing options except the placeholder
             while (addDurationSelect.options.length > 1) {
                 addDurationSelect.remove(1);
             }
             addDurationSelect.value = ""; // Reset selection
             addDurationSelect.disabled = true; // Disable initially

             const typeData = appointmentTypesData.find(item =>
                item.appointment_type.toLowerCase().replace(/ /g, '_') === selectedTypeValue
             );

             if (typeData && typeData.durations && typeData.durations.length > 0) {
                typeData.durations.forEach(duration => {
                    const option = document.createElement('option');
                    option.value = duration;
                    // Simple text for now, could format like '1 hour' if needed
                    option.text = `${duration} minutes`;
                    addDurationSelect.appendChild(option);
                });
                // Select the first duration as default
                if (addDurationSelect.options.length > 1) {
                   addDurationSelect.selectedIndex = 1;
                }
                 addDurationSelect.disabled = false; // Enable select

             } else if (selectedTypeValue === 'custom') {
                 // For custom, maybe allow free selection or default? Add common options.
                  ['30', '60', '90'].forEach(duration => { // Example default durations for custom
                     const option = document.createElement('option');
                     option.value = duration;
                     option.text = `${duration} minutes`;
                     addDurationSelect.appendChild(option);
                  });
                 if (addDurationSelect.options.length > 1) {
                    addDurationSelect.selectedIndex = 1; // Default custom to 30?
                 }
                  addDurationSelect.disabled = false; // Enable select
             } else {
                 // Fallback if type has no duration - add default 30 min
                 const option = document.createElement('option');
                 option.value = "30";
                 option.text = '30 minutes';
                 addDurationSelect.appendChild(option);
                 addDurationSelect.selectedIndex = 1;
                 addDurationSelect.disabled = false; // Enable select
             }
        }


        function updateAddFormBasedOnAppointmentType() {
            if (!addAppointmentTypeSelect) return;
            const selectedType = addAppointmentTypeSelect.value;

            updateAddDurationOptions(); // Update durations

            // Reason Logic
            if (addReasonLabel && addReasonField) {
                if (selectedType === 'custom') {
                    addReasonLabel.innerHTML = 'Custom Appointment Notes:*'; // Indicate required
                    addReasonField.required = true;
                    addReasonField.placeholder = 'Enter details for the custom appointment type';
                } else {
                    addReasonLabel.textContent = 'Additional Notes:';
                    addReasonField.required = false;
                     addReasonField.placeholder = '';
                }
            }
        }

        if (addAppointmentTypeSelect) {
            addAppointmentTypeSelect.addEventListener('change', updateAddFormBasedOnAppointmentType);
            // Initial call in case a value is pre-selected (e.g., form validation failure)
            if (addAppointmentTypeSelect.value) {
                 updateAddFormBasedOnAppointmentType();
            } else {
                 addDurationSelect.disabled = true; // Keep duration disabled if no type selected
            }
        }


        // --- Find Slots Modal Logic ---
        const findSlotsModalElement = document.getElementById('findSlotsModal');
        if (findSlotsModalElement) {
            findSlotsModalElement.addEventListener('show.bs.modal', async function (event) {
                const button = event.relatedTarget;
                const patientId = button.getAttribute('data-patient-id');
                const patientName = button.getAttribute('data-patient-name');

                const modalTitle = findSlotsModalElement.querySelector('.modal-title');
                const patientNameSpan = findSlotsModalElement.querySelector('#find-slots-modal-patient-name');
                const slotListDiv = findSlotsModalElement.querySelector('#find-slots-modal-list');

                modalTitle.textContent = `Matching Slots for ${escapeHTML(patientName)}`;
                if(patientNameSpan) patientNameSpan.textContent = escapeHTML(patientName);
                slotListDiv.innerHTML = `<div class="text-center p-4"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>`; // Show spinner

                try {
                    // Fetch matching slots FOR THE PATIENT from the new API endpoint
                    const response = await fetch(`/api/find_matches_for_patient/${patientId}`); // Use the new endpoint
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({error: `HTTP error! status: ${response.status}`}));
                        throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                    }
                    const data = await response.json(); // Expect { patient_name: ..., slots: [...] }

                    // Update patient name in modal with value from API response
                    if (patientNameSpan && data.patient_name) {
                        patientNameSpan.textContent = escapeHTML(data.patient_name);
                    }
                    if (modalTitle && data.patient_name) {
                        modalTitle.textContent = `Matching Slots for ${escapeHTML(data.patient_name)}`;
                    }

                    const patientName = data.patient_name || '';
                    const patientFirstName = patientName.split(' ')[0];
                    // const patientApptType = ''; // Not present in backend response

                    const slots = data.slots || data.matching_slots || [];
                    if (slots.length > 0) {
                        slotListDiv.innerHTML = '';
                        slots.forEach(slot => {
                            const card = document.createElement('div');
                            card.className = 'card mb-3 shadow-sm'; // Add shadow

                            const displayDate = formatDisplayDate(slot.date);
                            let timeDisplay = slot.start_time ? ` at ${slot.start_time}` : '';
                            let dateTimeStr = `${displayDate}${timeDisplay}`;

                            let notesHtml = slot.notes ? `<br><small class=\"text-muted\"><i class=\"bi bi-journal-text\"></i> ${escapeHTML(slot.notes)}</small>` : '';

                            card.innerHTML = `
                                <div class=\"card-body\">
                                    <div class=\"d-flex justify-content-between align-items-start\">
                                        <div>
                                            <h6 class=\"card-title mb-1\">${escapeHTML(slot.provider_name)}</h6>
                                            <div class=\"slot-details\">
                                                <i class=\"bi bi-calendar-event\"></i> ${dateTimeStr}<br>
                                                <i class=\"bi bi-clock-history\"></i> ${escapeHTML(slot.duration)} min
                                        ${notesHtml}
                                    </div>
                                        </div>
                                        <button type=\"button\" class=\"btn btn-sm btn-info propose-slot-btn\"
                                                data-bs-toggle=\"modal\" data-bs-target=\"#proposeSlotModal\"
                                                data-patient-id=\"${escapeHTML(patientId)}\"
                                                data-patient-name=\"${escapeHTML(patientName)}\"
                                                data-patient-first-name=\"${escapeHTML(patientFirstName)}\"
                                                data-slot-id=\"${escapeHTML(slot.id)}\"
                                                data-slot-details=\"${escapeHTML(dateTimeStr)} w/ ${escapeHTML(slot.provider_name)}\"
                                                title=\"Prepare Proposal Message\">
                                            <i class=\"bi bi-send\"></i> Propose
                                        </button>
                                    </div>
                                </div>`;
                            slotListDiv.appendChild(card);
                        });
                    } else {
                        const displayName = data.patient_name || patientName;
                        slotListDiv.innerHTML = `<div class="alert alert-info mb-0">No available slots found matching ${escapeHTML(displayName)}'s requirements.</div>`;
                    }
                } catch (error) {
                    console.error('Error fetching matching slots:', error);
                    slotListDiv.innerHTML = `<div class="alert alert-danger">Error loading slots: ${error.message || 'Please try again later.'}</div>`;
                }
            });
        }


        // --- Propose Slot Modal Logic (Triggered from Find Slots Modal) ---
        const proposeModalElement = document.getElementById('proposeSlotModal');
        if (proposeModalElement) {
             const copyButton = proposeModalElement.querySelector('#copyTemplateButton');
             const markProposedButton = proposeModalElement.querySelector('#markProposedButton');
             const markProposedForm = proposeModalElement.querySelector('#markProposedForm');
             const modalBodyTextarea = proposeModalElement.querySelector('#modalEmailBody');
             const modalPatientNameSpan = proposeModalElement.querySelector('#propose-modal-patient-name');
             const modalSlotDetailsSpan = proposeModalElement.querySelector('#propose-modal-slot-details');

             proposeModalElement.addEventListener('show.bs.modal', function (event) {
                // This modal is triggered by a button *inside* the findSlotsModal
                const button = event.relatedTarget;
                const patientId = button.getAttribute('data-patient-id');
                const patientName = button.getAttribute('data-patient-name');
                const patientFirstName = button.getAttribute('data-patient-first-name') || patientName.split(' ')[0];
                const slotId = button.getAttribute('data-slot-id');
                const slotDetails = button.getAttribute('data-slot-details');
                let appointmentType = button.getAttribute('data-appointment-type'); // Raw type e.g. 'np_spec'

                // Format appointment type for display in message
                 if (appointmentType) {
                    appointmentType = appointmentType.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()); // Basic title case
                     if (appointmentType.toLowerCase() === 'rct') appointmentType = 'RCT'; // Specific cases
                     if (appointmentType.toLowerCase() === 'x-ray') appointmentType = 'X-Ray';
                     if (appointmentType.toLowerCase() === 'np spec') appointmentType = 'New Patient Special'; // Example expansion
                 } else {
                    appointmentType = 'appointment'; // Fallback
                 }

                // Populate modal labels
                 if(modalPatientNameSpan) modalPatientNameSpan.textContent = escapeHTML(patientName);
                 if(modalSlotDetailsSpan) modalSlotDetailsSpan.textContent = escapeHTML(slotDetails);

                // Retrieve sender info from textarea data attributes
                const userName = modalBodyTextarea.getAttribute('data-user-name');
                const clinicName = modalBodyTextarea.getAttribute('data-clinic-name');
                const senderInfo = `${userName} from ${clinicName}`; // Construct sender string

                // Construct email body
                const emailBody = `Hi ${escapeHTML(patientFirstName)},\n\nThis is ${senderInfo}. We have an opening on ${escapeHTML(slotDetails)}, and would love to know if you could make it in for your ${escapeHTML(appointmentType)}?\n\nPlease let us know as soon as possible if this time works for you.\n\nThanks!`;
                modalBodyTextarea.value = emailBody;

                // Set up the Mark Proposed form action
                const proposeUrl = `/propose_slot/${slotId}/${patientId}`; // Correct URL structure
                 if (markProposedForm) markProposedForm.action = proposeUrl;

                 // Reset button states
                 if (copyButton) {
                     copyButton.textContent = 'Copy Message';
                     copyButton.disabled = false;
                 }
                 if (markProposedButton) {
                     markProposedButton.disabled = false;
                     markProposedButton.innerHTML = '<i class="bi bi-bookmark-check"></i> Mark Proposed'; // Reset text/icon
                 }
             });

             // Copy button functionality
             if (copyButton) {
                 copyButton.addEventListener('click', function() {
                     const messageText = modalBodyTextarea.value;
                     navigator.clipboard.writeText(messageText).then(() => {
                         copyButton.textContent = 'Copied!';
                         copyButton.disabled = true;
                         setTimeout(() => {
                            if (proposeModalElement.classList.contains('show')) { // Check if modal is still open
                                 copyButton.textContent = 'Copy Message';
                                 copyButton.disabled = false;
                            }
                         }, 2000);
                     }).catch(err => {
                         console.error('Failed to copy text: ', err);
                         copyButton.textContent = 'Copy Failed!';
                         setTimeout(() => { copyButton.textContent = 'Copy Message'; }, 2000);
                    });
                 });
             }

             // Mark Proposed button functionality (submits the hidden form)
             if (markProposedButton && markProposedForm) {
                 markProposedButton.addEventListener('click', function(e) {
                     e.preventDefault(); // Always prevent default first
                     const patientName = modalPatientNameSpan ? modalPatientNameSpan.textContent : 'the patient';
                     
                     if (confirm(`Mark this slot as proposed to ${patientName}? The patient and slot status will be updated.`)) {
                         // Disable button immediately to prevent double submission
                         markProposedButton.disabled = true;
                         markProposedButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Marking...';
                         
                         // Submit the form
                         markProposedForm.submit();
                     }
                 });
             }
        }


        // --- Scroll to Table Hash if present ---
        if(window.location.hash === '#waitlist-table') {
            const tableElement = document.getElementById('patients-table');
            if (tableElement) {
                tableElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        // --- Remove Patient via JS Form Submission ---
        document.querySelectorAll('.remove-patient-btn').forEach(button => {
            button.addEventListener('click', function(event) {
                const patientId = this.dataset.patientId;
                const patientName = this.dataset.patientName;

                if (confirm(`Are you sure you want to remove ${patientName}?`)) {
                    const form = document.createElement('form');
                    form.method = 'POST';
                    form.action = `/remove_patient/${patientId}`;
                    
                    // Hide the form so it doesn't appear on screen
                    form.style.display = 'none'; 
                    
                    document.body.appendChild(form);
                    form.submit();
                }
            });
        });

    }); // End DOMContentLoaded
</script>
{% endblock %} {# End of scripts block #}