{% extends "base.html" %}

{% block title %}Manage Open Slots{% endblock %}

{% block head %}
{{ super() }}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
<style>
    /* Styles needed for this page (from index/cancelled_appointments) */
    .eligibility-match { background-color: #d1e7dd; /* Greenish */ }
    .patient-match-indicator { width: 12px; height: 12px; display: inline-block; border-radius: 50%; margin-right: 5px; background-color: #198754; }
    .patient-details { font-size: 0.9rem; color: #6c757d; }
    .slot-details { font-size: 0.9rem; color: #6c757d; }
    .action-buttons form, .action-buttons a, .action-buttons button { display: inline-block; margin-bottom: 5px; margin-right: 3px; } /* Adjusted for inline-block */
    .action-buttons .btn-group { display: block; width: 100%; } /* Group confirm/cancel */
    .propose-slot-btn {} /* Placeholder */
    .patient-availability { font-size: 0.85em; color: #6c757d; }
    /* Urgency badge styles (needed for eligible patient list) */
    .badge.urgency-high { background-color: #dc3545; color: white; }
    .badge.urgency-medium { background-color: #ffc107; color: black; }
    .badge.urgency-low { background-color: #0dcaf0; color: black; }
    .slot-pending { background-color: #fff3cd; border-left: 5px solid #ffc107; } /* Yellowish highlight for pending slots */
    .patient-pending { font-style: italic; color: #6c757d; } /* Style for pending patients in waitlist (apply in index.html too) */
</style>
{% endblock %}

{% block content %} 
{# Macro needed for formatting appointment types in eligible patient list #}
{% macro format_appointment_type(patient) %}
    {% set appt_type = patient.appointment_type.strip()|lower %}
    {% if appt_type == 'custom' %}
        Custom: {{ patient.reason|default('N/A', true) }}
    {% elif appt_type == 'rct' %}
        RCT
    {% elif appt_type == 'x-ray' or appt_type == 'xray' %}
        X-Ray
    {% elif appt_type == 'np_spec' or appt_type == 'np spec' %}
        NP Spec
    {% elif '_' in patient.appointment_type or ' ' in patient.appointment_type %}
        {{ patient.appointment_type.strip()|replace('_', ' ')|title }}
    {% else %}
        {{ patient.appointment_type.strip()|capitalize }}
    {% endif %}
{% endmacro %}

<div class="container">
    <h1 class="display-5 text-center mb-4">Manage Open Slots</h1>

    <div class="row mb-4">
        {# --- Add Open Slot Form --- #}
        <div class="col-md-6">
            <div class="card" id="add-slot-form">
                <div class="card-body">
                    <h5 class="card-title">Add Open Slot</h5>
                    {% if not has_providers %}
                    <div class="alert alert-warning" role="alert">
                        Please add providers first via the <a href="{{ url_for('providers.list_providers') }}">Manage Providers</a> page.
                    </div>
                    {% else %}
                    <form action="{{ url_for('slots.add_cancelled_appointment') }}" method="post">
                        <div class="mb-3">
                            <label for="slot_provider" class="form-label">Provider</label>
                            <select class="form-select" id="slot_provider" name="provider" required>
                                <option value="" selected disabled>Select Provider</option>
                                {% for provider in providers %}
                                    <option value="{{ provider.id }}">{{ provider.first_name }}{% if provider.last_initial %} {{ provider.last_initial }}{% endif %}</option>
                                {% endfor %}
                            </select>
                        </div>
                         <div class="row">
                             <div class="col-md-6 mb-3">
                                <label for="date" class="form-label">Date</label>
                                <input type="date" class="form-control" id="date" name="date" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="time" class="form-label">Time</label>
                                <input type="time" class="form-control" id="time" name="time" required>
                            </div>
                         </div>
                        <div class="mb-3">
                            <label for="duration" class="form-label">Duration</label>
                            <select class="form-select" id="duration" name="duration" required>
                                <option value="" disabled selected>Select Duration</option>
                                <option value="30">30 minutes</option>
                                <option value="60">1 hour</option>
                                <option value="70">70 minutes</option>
                                <option value="90">1.5 hours</option>
                                <option value="120">2 hours</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="notes" class="form-label">Notes (Optional)</label>
                            <textarea class="form-control" id="notes" name="notes" rows="2"></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary">Add Slot</button>
                    </form>
                    {% endif %}
                </div>
            </div>
        </div>

        {# --- Current Open Slots List --- #}
        <div class="col-md-6">
            <div class="card" id="cancelled-slots-list">
                <div class="card-header">
                    <h5 class="mb-0">Current Open Slots</h5>
                </div>
                 <div class="list-group list-group-flush" style="max-height: 400px; overflow-y: auto;"> {# Added scroll for long lists #}
                    {% if slots %}
                        {% for appointment in slots %}
                            {# Add slot-pending class if status is pending #}
                            <div class="list-group-item {% if appointment.status == 'pending' %}slot-pending{% endif %}" id="slot-{{ appointment.id }}">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <strong>{{ appointment.provider | default('Unknown Provider') }}</strong><br>
                                        <div class="slot-details">
                                            {% if appointment.date %}
                                                {{ appointment.date }}
                                            {% endif %}
                                            {% if appointment.start_time %} at {{ appointment.start_time }}
                                            {% endif %}
                                            <br> Duration: {{ appointment.duration }} minutes
                                            {% if appointment.notes %} <br>Notes: {{ appointment.notes }} {% endif %}
                                            {# Display Pending Status #}
                                            {% if appointment.status == 'pending' %}
                                                <br><span class="badge bg-warning text-dark">Pending Confirmation: {{ appointment.proposed_patient_name | default('N/A') }}</span>
                                            {% elif appointment.status == 'filled' %} {# Optional: If you keep filled slots #}
                                                 <br><span class="badge bg-secondary">Filled</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="text-end action-buttons">
                                        {% if appointment.status == 'pending' and appointment.proposed_patient_id %}
                                            {# Pending State Actions #}
                                            <div class="btn-group-vertical btn-group-sm" role="group" aria-label="Pending Actions">
                                                <form action="{{ url_for('slots.confirm_booking', slot_id=appointment.id, patient_id=appointment.proposed_patient_id) }}" method="post" class="d-inline">
                                                    <button type="submit" class="btn btn-success w-100" title="Confirm Booking">
                                                        <i class="bi bi-check-circle"></i> Confirm
                                                    </button>
                                                </form>
                                                <form action="{{ url_for('slots.cancel_proposal', slot_id=appointment.id, patient_id=appointment.proposed_patient_id) }}" method="post" class="d-inline">
                                                    <button type="submit" class="btn btn-warning w-100" title="Cancel Proposal">
                                                        <i class="bi bi-x-circle"></i> Cancel Prop.
                                                    </button>
                                                </form>
                                            </div>
                                        {% elif appointment.status == 'available' or not appointment.status %} {# Available State Actions #}
                                            {# Find Matches Form #}
                                            <form action="{{ url_for('slots.find_matches_for_appointment', appointment_id=appointment.id) }}" method="post">
                                                <button type="submit" class="btn btn-sm btn-outline-primary" title="Find Matches">
                                                    <i class="bi bi-search"></i> Find Matches
                                                </button>
                                            </form>
                                            {# Edit Button - Triggers Edit Slot Modal #}
                                            <button type="button" class="btn btn-sm btn-outline-secondary edit-slot-button"
                                                    data-bs-toggle="modal"
                                                    data-bs-target="#editSlotModal"
                                                    data-slot-id="{{ appointment.id }}"
                                                    data-provider-name="{{ appointment.provider_name }}"
                                                    data-duration="{{ appointment.duration }}"
                                                    data-slot-date="{{ appointment.date }}"
                                                    data-slot-time="{{ appointment.start_time }}"
                                                    data-notes="{{ appointment.notes }}"
                                                    title="Edit Slot">
                                                 <i class="bi bi-pencil"></i> Edit
                                            </button>
                                            {# Remove Form #}
                                            <form action="{{ url_for('slots.remove_cancelled_slot', appointment_id=appointment.id) }}" method="post" onsubmit="return confirm('Remove this open slot?');">
                                                <button type="submit" class="btn btn-sm btn-outline-danger" title="Remove Slot">
                                                    <i class="bi bi-trash"></i> Remove
                                                </button>
                                            </form>
                                         {% elif appointment.status == 'filled' %}
                                             <span class="badge bg-secondary">Filled</span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    {% else %}
                        <div class="list-group-item text-center">No open slots available.</div>
                    {% endif %}
                 </div> {# End scrollable list group #}
            </div>
        </div>
    </div>

    {# --- Eligible Patients Section (shown conditionally after Find Matches) --- #}
    <div id="eligible-patients-section" class="row mb-4" style="display: {% if eligible_patients is not none and current_appointment and current_appointment.status != 'pending' %}block{% else %}none{% endif %};">
      <div class="col-md-12">
        <div class="card border-primary">
          <div class="card-header bg-primary text-white">
            <h5 class="mb-0">Eligible Patients Found for Slot</h5>
            <p class="mb-0" id="eligible-patients-slot-info">
              {% if current_appointment and current_appointment.date %}
                {{ current_appointment.date }}
                {% if current_appointment.start_time %} at {{ current_appointment.start_time }}
                {% endif %}
                | Provider: {{ current_appointment.provider_name | default('N/A') }} | Duration: {{ current_appointment.duration }} minutes
              {% else %}
                Slot Information Unavailable
              {% endif %}
            </p>
          </div>
          <div class="card-body p-0">
            {# Check if eligible_patients is defined and not empty #}
            {% if eligible_patients is defined and eligible_patients %}
              <div class="table-responsive">
                <table class="table table-hover mb-0">
                  <thead>
                    <tr>
                      <th>Match</th>
                      <th>Patient</th>
                      <th>Contact</th>
                      <th>Availability</th>
                      <th>Wait Time</th>
                      <th>Appointment Details</th>
                      <th>Action</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for patient in eligible_patients %}
                    {# Ensure patient status is 'waiting' before showing propose options #}
                    {% if patient.status == 'waiting' or not patient.status %}
                    <tr class="eligibility-match">
                      <td>
                        {# Add logic for match quality if desired #}
                        <span class="patient-match-indicator"></span>
                        <span class="fw-bold">Match</span>
                      </td>
                      <td>
                        {{ patient.name }}
                        {# --- ADDED URGENCY BADGE HERE --- #}
                        {% set urgency_lower = patient.urgency|lower if patient.urgency else 'medium' %} {# Default to medium #}
                        {% set urgency_class = 'urgency-medium' %} {# Default class #}
                        {% if urgency_lower == 'high' %}
                            {% set urgency_class = 'urgency-high' %}
                        {% elif urgency_lower == 'low' %}
                            {% set urgency_class = 'urgency-low' %}
                        {% endif %}
                        <span class="badge {{ urgency_class }} ms-2">{{ patient.urgency|capitalize }}</span>
                        {# --- END URGENCY BADGE --- #}
                      </td>
                      <td>
                        {{ patient.phone }}<br>
                        <small>{{ patient.email or "No email" }}</small>
                      </td>
                      <td> {# Availability Display #}
                        {% set availability = patient.get('availability', {}) %}
                        {% if not availability %}
                          <span class="text-muted">Any Day/Time</span>
                        {% else %}
                          <span class="patient-availability">
                          <strong class="text-success">Available:</strong>
                          {# Use capitalize for display consistency #}
                          {% for day, periods in availability.items()|sort %}
                            {{ day[:3].capitalize() }}({{ periods|join('/') }}){% if not loop.last %}; {% endif %}
                          {% endfor %}
                          </span>
                        {% endif %}
                      </td>
                      <td>{{ patient.wait_time }}</td>
                      <td> {# Appointment Details - Check provider match styling #}
                        <div class="patient-details">
                          <div><strong>Type:</strong> {{ format_appointment_type(patient) }}</div>
                          <div><strong>Duration:</strong> {{ patient.duration }} min</div>
                          <div><strong>Provider Pref:</strong>
                            {% set patient_provider_lower = patient.provider|lower if patient.provider else 'no preference' %}
                            {% set slot_provider_lower = current_appointment.provider_name|lower if current_appointment and current_appointment.provider_name else '' %}
                            {% if patient_provider_lower == slot_provider_lower %}
                              <span class="text-success">{{ patient.provider }}</span>
                            {% elif patient_provider_lower == 'no preference' %}
                              <span class="text-muted">No Preference</span>
                            {% else %}
                              {# This means patient wants a specific provider NOT matching the slot #}
                              <span class="text-danger">{{ patient.provider }}</span> {# Should not be eligible based on backend filter, but good UI check #}
                            {% endif %}
                          </div>
                          {% if patient.reason %}
                            <div><strong>Notes:</strong> {{ patient.reason }}</div>
                          {% endif %}
                        </div>
                      </td>
                      <td> {# Action Buttons: Propose + Mark as Proposed #}
                        {% if patient.id and current_appointment.id and current_appointment.date and current_appointment.start_time %}
                           {# Propose Slot Button (Opens Modal) #}
                          <button type="button" class="btn btn-sm btn-info propose-slot-btn"
                                  data-bs-toggle="modal" data-bs-target="#proposeSlotModal"
                                  data-patient-id="{{ patient.id }}"
                                  data-patient-name="{{ patient.name }}"
                                  data-patient-first-name="{{ patient.name.split()[0] }}"
                                  data-appointment-id="{{ current_appointment.id }}"
                                  data-slot-weekday="{% if current_appointment.date %}{{ current_appointment.date }}{% else %}Unknown{% endif %}"
                                  data-slot-date-str="{% if current_appointment.date %}{{ current_appointment.date }}{% else %}Unknown{% endif %}"
                                  data-slot-time="{{ current_appointment.start_time }}"
                                  data-appointment-type="{{ format_appointment_type(patient)|replace(':', '')|trim }}"
                                  data-provider-name="{{ current_appointment.provider_name | default('the provider') }}"
                                  data-patient-email="{{ patient.email or '' }}">
                            <i class="bi bi-send"></i> Propose
                          </button>
                          {# Mark as Proposed Button (Submits Form) #}
                           <form action="{{ url_for('slots.propose_slot', slot_id=current_appointment.id, patient_id=patient.id) }}" method="post" class="d-inline" onsubmit="return confirm('Mark this slot as proposed to {{ patient.name }}?');">
                                <button type="submit" class="btn btn-sm btn-outline-warning" title="Mark as Proposed">
                                     <i class="bi bi-bookmark-check"></i> Mark Proposed
                                </button>
                            </form>
                        {% else %}
                          <button class="btn btn-sm btn-secondary" disabled title="Missing patient/slot data">Error</button>
                        {% endif %}
                      </td>
                    </tr>
                    {% endif %} {# End check for patient status 'waiting' #}
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            {% else %}
              <div class="alert alert-info mb-0">
                {% if current_appointment and current_appointment.status == 'pending' %}
                    This slot is currently pending confirmation with another patient.
                {% else %}
                    No eligible waiting patients found matching the provider, duration, and availability for this slot.
                {% endif %}
              </div>
            {% endif %}
          </div> {# End card-body #}
        </div> {# End card #}
      </div> {# End col #}
    </div> {# End eligible patients row #}

</div>{# End container #}

<!-- Edit Slot Modal -->
<div class="modal fade" id="editSlotModal" tabindex="-1" aria-labelledby="editSlotModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editSlotModalLabel">Edit Open Slot</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="edit-slot-form" action="{{ url_for('slots.update_cancelled_slot', appointment_id='SLOT_ID_PLACEHOLDER') }}" method="post">
          <div class="mb-3">
            <label for="edit_slot_provider" class="form-label">Provider</label>
            <select class="form-select" id="edit_slot_provider" name="provider" required>
              <option value="" disabled>Select Provider</option>
              {% for provider in providers %}
                <option value="{{ provider.id }}">{{ provider.first_name }}{% if provider.last_initial %} {{ provider.last_initial }}{% endif %}</option>
              {% endfor %}
            </select>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="edit_slot_date" class="form-label">Date</label>
              <input type="date" class="form-control" id="edit_slot_date" name="date" required>
            </div>
            <div class="col-md-6 mb-3">
              <label for="edit_slot_time" class="form-label">Time</label>
              <input type="time" class="form-control" id="edit_slot_time" name="time" required step="1800">
            </div>
          </div>
          <div class="mb-3">
            <label for="edit_slot_duration" class="form-label">Duration</label>
            <select class="form-select" id="edit_slot_duration" name="duration" required>
              <option value="" disabled>Select Duration</option>
              <option value="30">30 minutes</option>
              <option value="60">1 hour</option>
              <option value="70">70 minutes</option>
              <option value="90">1.5 hours</option>
              <option value="120">2 hours</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="edit_slot_notes" class="form-label">Notes (Optional)</label>
            <textarea class="form-control" id="edit_slot_notes" name="notes" rows="2"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" form="edit-slot-form" class="btn btn-primary">Save Changes</button>
      </div>
    </div>
  </div>
</div>

<!-- Propose Slot Modal -->
<div class="modal fade" id="proposeSlotModal" tabindex="-1" aria-labelledby="proposeSlotModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="proposeSlotModalLabel">Proposal Message</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label for="modalEmailBody" class="form-label">Message Template:</label>
          {# Pass user/clinic name info from backend in data attributes for JS - REMOVED |tojson #}
          <textarea class="form-control" id="modalEmailBody" name="email_body" rows="10" readonly
                    data-user-name="{{ current_user_name }}"
                    data-clinic-name="{{ current_clinic_name }}"></textarea>
        </div>
         {# --- ADDED: Hidden form for marking as proposed from modal --- #}
        <form id="modal-propose-form" action="" method="post" class="d-none">
            {# Values will be populated by JS #}
        </form>
         {# --- END ADDED --- #}
      </div>
      <div class="modal-footer justify-content-between">
        {# Left side: Mark Proposed button #}
        <button type="submit" form="modal-propose-form" class="btn btn-warning" id="modalMarkProposedButton" title="Mark slot and patient as pending">
            <i class="bi bi-bookmark-check"></i> Mark Proposed
        </button>
        {# Right side: Copy and Close buttons #}
        <div>
            <button type="button" class="btn btn-primary" id="copyTemplateButton">
              <i class="bi bi-clipboard"></i> Copy Message
            </button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock %} {# End content block #}

{% block scripts %}
{{ super() }}
{# Import datetime object if needed by JS, although Jinja formatting is preferred #}
<script>
    // Make datetime available if needed, although formatting in Jinja is better

    document.addEventListener('DOMContentLoaded', function() {
        // --- Date Input Logic ---
        const dateInputs = document.querySelectorAll('input[type="date"]');
        const today = new Date().toISOString().split('T')[0];
        dateInputs.forEach(input => {
            input.min = today; // Prevent selecting past dates in both add and edit forms
        });

        // --- Edit Slot Modal Logic ---
        const editSlotModal = document.getElementById('editSlotModal');
        if (editSlotModal) {
            editSlotModal.addEventListener('show.bs.modal', function(event) {
                const button = event.relatedTarget;
                const slotId = button.getAttribute('data-slot-id');
                const form = document.getElementById('edit-slot-form');

                // Update the form action URL
                let actionUrl = "{{ url_for('slots.update_cancelled_slot', appointment_id='SLOT_ID_PLACEHOLDER') }}";
                if (actionUrl.includes('SLOT_ID_PLACEHOLDER')) {
                    form.action = actionUrl.replace('SLOT_ID_PLACEHOLDER', slotId);
                }

                // Populate form fields from data attributes
                // Find the provider option that matches the provider name
                const providerName = button.getAttribute('data-provider-name');
                const providerSelect = document.getElementById('edit_slot_provider');
                for (let option of providerSelect.options) {
                    if (option.text === providerName) {
                        providerSelect.value = option.value;
                        break;
                    }
                }
                document.getElementById('edit_slot_date').value = button.getAttribute('data-slot-date');
                
                // Format time value to ensure HH:MM format
                const timeValue = button.getAttribute('data-slot-time');
                if (timeValue) {
                    const [hours, minutes] = timeValue.split(':');
                    const formattedTime = `${hours.padStart(2, '0')}:${minutes.padStart(2, '0')}`;
                    document.getElementById('edit_slot_time').value = formattedTime;
                }
                
                document.getElementById('edit_slot_duration').value = button.getAttribute('data-duration');
                document.getElementById('edit_slot_notes').value = button.getAttribute('data-notes') || '';
            });
        }

        // --- Propose Slot Modal Logic ---
        const proposeModalElement = document.getElementById('proposeSlotModal');
        const copyButton = document.getElementById('copyTemplateButton');
        const modalMarkProposedButton = document.getElementById('modalMarkProposedButton'); // Get the new button
        const modalProposeForm = document.getElementById('modal-propose-form'); // Get the hidden form


        if (proposeModalElement && copyButton && modalMarkProposedButton && modalProposeForm) { // Added checks for new elements
            proposeModalElement.addEventListener('show.bs.modal', function(event) {
                const button = event.relatedTarget; // Button that triggered the modal
                const patientId = button.getAttribute('data-patient-id'); // Get patient ID
                const appointmentId = button.getAttribute('data-appointment-id'); // Get slot ID
                const patientName = button.getAttribute('data-patient-name');
                const patientFirstName = button.getAttribute('data-patient-first-name') || patientName.split(' ')[0]; // Fallback
                const slotDateRaw = button.getAttribute('data-slot-weekday'); // This now contains the date string
                const slotTime = button.getAttribute('data-slot-time');
                const appointmentType = button.getAttribute('data-appointment-type');
                const providerName = button.getAttribute('data-provider-name');

                const modalTitle = proposeModalElement.querySelector('.modal-title');
                const modalBodyTextarea = proposeModalElement.querySelector('#modalEmailBody');

                // Retrieve sender info from the textarea's data attributes
                const userName = modalBodyTextarea.getAttribute('data-user-name');
                const clinicName = modalBodyTextarea.getAttribute('data-clinic-name');
                const senderInfo = `${userName} from ${clinicName}`; // Construct sender string

                modalTitle.textContent = `Proposal Message for ${patientName}`;

                // Format the date properly using JavaScript
                let dateTimeString = 'an upcoming opening';
                if (slotDateRaw && slotDateRaw !== 'Unknown') {
                    try {
                        const dateObj = new Date(slotDateRaw + 'T00:00:00');
                        const weekday = dateObj.toLocaleDateString('en-US', { weekday: 'short' });
                        const dateStr = dateObj.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                        let timeString = slotTime ? ` at ${slotTime}` : '';
                        dateTimeString = `${weekday}, ${dateStr}${timeString}`;
                    } catch (e) {
                        console.error('Error formatting date:', e);
                        dateTimeString = slotDateRaw + (slotTime ? ` at ${slotTime}` : '');
                    }
                }

                const emailBody = `Subject: Available Appointment: ${dateTimeString} with ${providerName}\n\nHi ${patientFirstName},\n\nThis is ${senderInfo}. We have an opening on ${dateTimeString} with ${providerName}, and would love to know if you could make it in for your ${appointmentType}?\n\nPlease let us know as soon as possible if this time works for you.\n\nThanks!`;

                modalBodyTextarea.value = emailBody;
                copyButton.textContent = 'Copy Message';
                copyButton.disabled = false;

                // Update hidden form action and button
                if (patientId && appointmentId) {
                    // Construct the correct URL for the propose action
                    let proposeUrl = "{{ url_for('slots.propose_slot', slot_id='SLOT_ID_PLACEHOLDER', patient_id='PATIENT_ID_PLACEHOLDER') }}";
                    proposeUrl = proposeUrl.replace('SLOT_ID_PLACEHOLDER', appointmentId);
                    proposeUrl = proposeUrl.replace('PATIENT_ID_PLACEHOLDER', patientId);
                    modalProposeForm.action = proposeUrl;

                     // Add confirmation prompt to the modal's propose button
                    modalMarkProposedButton.onclick = function(e) {
                        if (!confirm(`Mark this slot as proposed to ${patientName}?`)) {
                             e.preventDefault(); // Prevent form submission if user cancels
                        }
                    };
                    modalMarkProposedButton.disabled = false; // Enable the button
                } else {
                    console.error("Missing patientId or appointmentId for modal propose form.");
                    modalProposeForm.action = ""; // Clear action if data is missing
                    modalMarkProposedButton.disabled = true; // Disable if data missing
                    modalMarkProposedButton.onclick = null; // Remove any previous handler
                }
            });

            copyButton.addEventListener('click', function() {
                const messageText = proposeModalElement.querySelector('#modalEmailBody').value;
                navigator.clipboard.writeText(messageText).then(() => {
                    copyButton.textContent = 'Copied!';
                    copyButton.disabled = true;
                    // Optionally, trigger the "Mark as Proposed" form submission here
                    // Or keep them separate actions for user control.
                    // Example: find the associated form and submit it
                    // const proposeButton = document.querySelector(`.propose-slot-btn[data-bs-target="#proposeSlotModal"]`); // Need a way to link modal back to specific button/form
                    // Find the 'Mark Proposed' button associated with this modal trigger if needed.

                    setTimeout(() => {
                        copyButton.textContent = 'Copy Message';
                        copyButton.disabled = false;
                    }, 2000);
                }).catch(err => {
                    console.error('Failed to copy text: ', err);
                    copyButton.textContent = 'Copy Failed!';
                    setTimeout(() => { copyButton.textContent = 'Copy Message'; }, 2000);
                });
            });

             // Optional: Add visual feedback when modal propose button is clicked
             modalMarkProposedButton.addEventListener('click', function() {
                if (modalProposeForm.action) { // Only if action is set
                    // Indicate processing (optional)
                    // this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Marking...';
                    // this.disabled = true;
                    // Form submission will happen automatically due to type="submit"
                }
            });


        } else {
            if (!proposeModalElement) console.error("Propose modal not found");
            if (!copyButton) console.error("Copy button not found");
            if (!modalMarkProposedButton) console.error("Modal Mark Proposed button not found"); // Added check
            if (!modalProposeForm) console.error("Modal Propose hidden form not found"); // Added check
        }

        // --- Scroll to Eligible Patients if Visible ---
        const eligiblePatientsSection = document.getElementById('eligible-patients-section');
        // Check display style AND if the section actually contains the eligible patients table body
        const eligibleTableBody = eligiblePatientsSection ? eligiblePatientsSection.querySelector('tbody') : null;
        if (eligiblePatientsSection && window.getComputedStyle(eligiblePatientsSection).display === 'block' && eligibleTableBody && eligibleTableBody.children.length > 0) {
             // Check if the URL hash points to this section
             if(window.location.hash === '#eligible-patients-section') {
                // Use smooth scrolling if available, otherwise jump
                eligiblePatientsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
             }
        }

        // Helper function to escape HTML (needed if dynamically adding HTML, less critical now)
        function escapeHTML(str) {
            if (!str) return '';
            return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
        }

    }); // End DOMContentLoaded
</script>
{% endblock %} {# End scripts block #} 